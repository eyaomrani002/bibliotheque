{# Notifications dropdown â€” shows bell with unread badge and a small dropdown list #}
{% if app.user %}
    {% set in_sidebar = in_sidebar|default(false) %}
    {# If included inline inside another top-right container, use `inline=true` to avoid fixed positioning #}
    {% set inline = inline|default(false) %}

    {% if in_sidebar %}
        {# Version Sidebar #}
        <div class="inline-block ml-auto">
            <button id="notifications-toggle-sidebar" class="relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-transparent text-white hover:bg-white/5 transition-colors">
                <i class="fas fa-bell text-lg"></i>
                <span id="notifications-badge-sidebar" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full min-w-[18px] min-h-[18px] transform scale-90" style="display:none">0</span>
            </button>

            <div id="notifications-dropdown-sidebar" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg flex items-center justify-between">
                    <strong class="text-gray-800 font-semibold">ðŸ”” Notifications</strong>
                    <button id="notifications-mark-all-sidebar" class="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors">
                        Tout marquer comme lu
                    </button>
                </div>
                <div id="notifications-items-sidebar" class="max-h-64 overflow-y-auto">
                    {<!-- Les notifications seront chargÃ©es ici par JavaScript -->}
                </div>
                <div class="px-4 py-2 text-center text-xs text-gray-500 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <a href="{{ path('app_contact_my') }}" class="text-blue-600 hover:text-blue-800 font-medium">
                        Voir mes messages
                    </a>
                </div>
            </div>
        </div>

    {% else %}
        {# Version Top Bar (dÃ©faut). When `inline` is true we render without fixed positioning so
           the caller can place the notifications inside its own fixed container. #}
        {% if inline %}
            <div id="notifications-root-inline" class="relative hidden lg:block">
                <div class="relative">
                    <button id="notifications-toggle" class="relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/90 text-slate-700 hover:bg-white hover:shadow-md transition-all duration-200">
                        <i class="fas fa-bell text-lg"></i>
                        <span id="notifications-badge" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full min-w-[18px] min-h-[18px] transform scale-90" style="display:none">0</span>
                    </button>

                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg flex items-center justify-between">
                            <strong class="text-gray-800 font-semibold">ðŸ”” Notifications</strong>
                            <button id="notifications-mark-all" class="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors">
                                Tout marquer comme lu
                            </button>
                        </div>
                        <div id="notifications-items" class="max-h-64 overflow-y-auto">
                            {<!-- Les notifications seront chargÃ©es ici par JavaScript -->}
                        </div>
                        <div class="px-4 py-2 text-center text-xs text-gray-500 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                            <a href="{{ path('app_contact_my') }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                Voir mes messages
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div id="notifications-root" class="fixed top-4 right-20 z-50 hidden lg:block">
                <div class="relative">
                    <button id="notifications-toggle" class="relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/90 text-slate-700 hover:bg-white hover:shadow-md transition-all duration-200">
                        <i class="fas fa-bell text-lg"></i>
                        <span id="notifications-badge" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full min-w-[18px] min-h-[18px] transform scale-90" style="display:none">0</span>
                    </button>

                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg flex items-center justify-between">
                            <strong class="text-gray-800 font-semibold">ðŸ”” Notifications</strong>
                            <button id="notifications-mark-all" class="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors">
                                Tout marquer comme lu
                            </button>
                        </div>
                        <div id="notifications-items" class="max-h-64 overflow-y-auto">
                            {<!-- Les notifications seront chargÃ©es ici par JavaScript -->}
                        </div>
                        <div class="px-4 py-2 text-center text-xs text-gray-500 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                            <a href="{{ path('app_contact_my') }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                Voir mes messages
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <script>
        // Configuration
        const isSidebar = {{ in_sidebar ? 'true' : 'false' }};
        const prefix = isSidebar ? '-sidebar' : '';
        const unreadUrl = '{{ path('notifications_unread') }}';
        const markAllReadUrl = '{{ path('notifications_mark_all_read') }}';

        // Ã‰lÃ©ments DOM
        const toggleBtn = document.getElementById(`notifications-toggle${prefix}`);
        const dropdown = document.getElementById(`notifications-dropdown${prefix}`);
        const badge = document.getElementById(`notifications-badge${prefix}`);
        const itemsContainer = document.getElementById(`notifications-items${prefix}`);
        const markAllBtn = document.getElementById(`notifications-mark-all${prefix}`);

        // Fonction pour charger les notifications
        async function fetchNotifications() {
            try {
                const res = await fetch(unreadUrl, {
                    headers: { 
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!res.ok) throw new Error('Erreur rÃ©seau');
                
                const { count, items } = await res.json();
                
                // Mettre Ã  jour le badge
                if (badge) {
                    if (count > 0) {
                        badge.style.display = 'inline-flex';
                        badge.textContent = count > 99 ? '99+' : count;
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Mettre Ã  jour la liste
                if (itemsContainer) {
                    itemsContainer.innerHTML = '';
                    
                    if (items.length === 0) {
                        itemsContainer.innerHTML = `
                            <div class="px-4 py-6 text-center text-gray-500">
                                <i class="fas fa-bell-slash text-2xl mb-2 text-gray-300"></i>
                                <p class="text-sm">Aucune notification</p>
                            </div>
                        `;
                    } else {
                        items.forEach(item => {
                            const notificationEl = createNotificationElement(item);
                            itemsContainer.appendChild(notificationEl);
                        });
                    }
                }
                
            } catch (error) {
                console.error('Erreur chargement notifications:', error);
                if (itemsContainer) {
                    itemsContainer.innerHTML = `
                        <div class="px-4 py-6 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-lg mb-2"></i>
                            <p class="text-sm">Erreur de chargement</p>
                        </div>
                    `;
                }
            }
        }

        // CrÃ©er un Ã©lÃ©ment de notification
        function createNotificationElement(item) {
            const div = document.createElement('div');
            div.className = 'px-4 py-3 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 cursor-pointer transition-colors';
            div.dataset.id = item.id;
            
            // IcÃ´ne selon le type
            const icons = {
                'info': 'fas fa-info-circle text-blue-500',
                'warning': 'fas fa-exclamation-triangle text-yellow-500',
                'success': 'fas fa-check-circle text-green-500',
                'error': 'fas fa-times-circle text-red-500'
            };
            const iconClass = icons[item.type] || icons.info;
            
            const timeAgo = getTimeAgo(item.createdAt);
            
            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <i class="${iconClass} text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm text-gray-900 mb-1">${escapeHtml(item.title)}</div>
                        <div class="text-xs text-gray-600 mb-1">${escapeHtml(item.message)}</div>
                        <div class="text-xxs text-gray-400">${timeAgo}</div>
                    </div>
                </div>
            `;
            
            // Clic sur la notification
            div.addEventListener('click', async () => {
                try {
                    await fetch(`/notifications/${item.id}/read`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    
                    // Rediriger si il y a une URL dans les donnÃ©es
                    if (item.data && item.data.actionUrl) {
                        window.location.href = item.data.actionUrl;
                    }
                    
                    fetchNotifications();
                } catch (error) {
                    console.error('Erreur marquer comme lu:', error);
                }
            });
            
            return div;
        }

        // Utilitaires
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Ã€ l\'instant';
            if (diffMins < 60) return `Il y a ${diffMins} min`;
            if (diffHours < 24) return `Il y a ${diffHours} h`;
            if (diffDays < 7) return `Il y a ${diffDays} j`;
            return date.toLocaleDateString();
        }

        // Gestionnaires d'Ã©vÃ©nements
        if (toggleBtn && dropdown) {
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    fetchNotifications();
                }
            });
        }

        if (markAllBtn) {
            markAllBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    const res = await fetch(markAllReadUrl, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    
                    if (res.ok) {
                        fetchNotifications();
                    }
                } catch (error) {
                    console.error('Erreur marquer tout comme lu:', error);
                }
            });
        }

        // Fermer le dropdown en cliquant ailleurs
        document.addEventListener('click', (e) => {
            if (dropdown && !dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Charger initialement et toutes les 30 secondes
        fetchNotifications();
        setInterval(fetchNotifications, 30000);
    </script>
{% endif %}