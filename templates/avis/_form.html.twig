{{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}
    <div class="grid grid-cols-1 gap-6">
        <!-- Note -->
        <div>
            {{ form_label(form.note, null, {
                'label_attr': {
                    'class': 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3'
                }
            }) }}
            <div class="flex items-center gap-2 mb-2" id="starRating">
                {% for i in 1..5 %}
                    <button type="button" 
                            class="text-3xl transition-transform hover:scale-110 {{ i <= (form.note.vars.value is defined ? form.note.vars.value : 0) ? 'text-amber-400' : 'text-gray-300' }}"
                            data-rating="{{ i }}">
                        <i class="fas fa-star"></i>
                    </button>
                {% endfor %}
            </div>
            {{ form_widget(form.note, {
                'attr': {
                    'class': 'hidden'
                }
            }) }}
            <div class="text-red-500 text-sm mt-1">
                {{ form_errors(form.note) }}
            </div>
        </div>

        <!-- Commentaire -->
        <div>
            {{ form_label(form.commentaire, null, {
                'label_attr': {
                    'class': 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                }
            }) }}
            {{ form_widget(form.commentaire, {
                'attr': {
                    'class': 'w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition',
                    'rows': 5,
                    'placeholder': 'Partagez votre expérience de lecture...'
                }
            }) }}
            <div class="text-red-500 text-sm mt-1">
                {{ form_errors(form.commentaire) }}
            </div>
            <p class="text-gray-500 text-sm mt-2" id="charCount">
                {% if form.commentaire.vars.value is defined and form.commentaire.vars.value is not null %}
                    {{ form.commentaire.vars.value|length }}
                {% else %}
                    0
                {% endif %}/500 caractères
            </p>
        </div>

        <!-- Statut actif -->
        {% if form.isActive is defined %}
        <div class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
            {{ form_widget(form.isActive, {
                'attr': {
                    'class': 'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600'
                }
            }) }}
            {{ form_label(form.isActive, null, {
                'label_attr': {
                    'class': 'text-sm font-medium text-gray-700 dark:text-gray-300'
                }
            }) }}
        </div>
        {% endif %}

        <!-- Livre (si présent dans le formulaire) -->
        {% if form.livre is defined %}
        <div>
            {{ form_label(form.livre, null, {
                'label_attr': {
                    'class': 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                }
            }) }}

            {# If the field already has a Livre entity value (prefilled), render the title and a hidden input so the form still submits the id #}
            {% if form.livre.vars.value is not null and (form.livre.vars.value.titre is defined) %}
                <p class="p-3 bg-gray-50 dark:bg-gray-700 rounded-md"><strong>{{ form.livre.vars.value.titre }}</strong></p>
                <input type="hidden" name="{{ form.livre.vars.full_name }}" value="{{ form.livre.vars.value.id }}">
            {% else %}
                {{ form_widget(form.livre, {
                    'attr': {
                        'class': 'w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition'
                    }
                }) }}
            {% endif %}

            <div class="text-red-500 text-sm mt-1">
                {{ form_errors(form.livre) }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Boutons -->
    <div class="flex items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-600">
        <button type="submit" 
                class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center justify-center gap-2">
            <i class="fas fa-{{ button_label|default('Enregistrer') == 'Enregistrer' ? 'save' : 'edit' }}"></i>
            {{ button_label|default('Enregistrer') }}
        </button>
        <a href="{{ path('app_avis_index') }}" 
           class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Annuler
        </a>
    </div>
{{ form_end(form, {'render_rest': render_rest is defined ? render_rest : true}) }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des étoiles pour la note
    const starButtons = document.querySelectorAll('#starRating button');
    const noteInput = document.getElementById('{{ form.note.vars.id }}');
    
    if (starButtons.length > 0 && noteInput) {
        starButtons.forEach(button => {
            button.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                noteInput.value = rating;
                
                // Mettre à jour l'affichage des étoiles
                starButtons.forEach((star, index) => {
                    const icon = star.querySelector('i');
                    if (index < rating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-amber-400');
                    } else {
                        star.classList.remove('text-amber-400');
                        star.classList.add('text-gray-300');
                    }
                });
            });
        });

        // Initialiser l'affichage des étoiles
        const currentRating = parseInt(noteInput.value) || 0;
        starButtons.forEach((star, index) => {
            if (index < currentRating) {
                star.classList.remove('text-gray-300');
                star.classList.add('text-amber-400');
            }
        });
    }

    // Compteur de caractères pour le commentaire
    const commentaireTextarea = document.getElementById('{{ form.commentaire.vars.id }}');
    const charCount = document.getElementById('charCount');
    
    if (commentaireTextarea && charCount) {
        // Mettre à jour le compteur initial
        updateCharCount();
        
        // Écouter les changements
        commentaireTextarea.addEventListener('input', updateCharCount);
        
        function updateCharCount() {
            const length = commentaireTextarea.value.length;
            charCount.textContent = `${length}/500 caractères`;
            
            // Changer la couleur si approche de la limite
            if (length > 450) {
                charCount.classList.add('text-red-500');
                charCount.classList.remove('text-gray-500');
            } else if (length > 400) {
                charCount.classList.add('text-amber-500');
                charCount.classList.remove('text-gray-500', 'text-red-500');
            } else {
                charCount.classList.remove('text-red-500', 'text-amber-500');
                charCount.classList.add('text-gray-500');
            }
            
            // Avertissement visuel si dépassement
            if (length > 500) {
                commentaireTextarea.classList.add('border-red-300', 'dark:border-red-600');
                commentaireTextarea.classList.remove('border-gray-300', 'dark:border-gray-600');
            } else {
                commentaireTextarea.classList.remove('border-red-300', 'dark:border-red-600');
                commentaireTextarea.classList.add('border-gray-300', 'dark:border-gray-600');
            }
        }
    }

    // Validation en temps réel
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            // Validation de la note
            if (noteInput && (!noteInput.value || noteInput.value < 1 || noteInput.value > 5)) {
                isValid = false;
                // Mettre en évidence les étoiles
                starButtons.forEach(star => {
                    star.classList.add('animate-pulse', 'text-red-400');
                });
            }
            
            // Validation du commentaire (optionnel mais recommandé)
            if (commentaireTextarea && commentaireTextarea.value.length > 500) {
                isValid = false;
                commentaireTextarea.classList.add('border-red-300', 'dark:border-red-600');
            }
            
            if (!isValid) {
                e.preventDefault();
                
                // Afficher un message d'erreur
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4';
                errorDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <div>
                            <p class="text-red-800 dark:text-red-200 font-medium">Veuillez corriger les erreurs ci-dessous</p>
                            <p class="text-red-600 dark:text-red-300 text-sm">- La note est obligatoire</p>
                            ${commentaireTextarea && commentaireTextarea.value.length > 500 ? '<p class="text-red-600 dark:text-red-300 text-sm">- Le commentaire ne peut pas dépasser 500 caractères</p>' : ''}
                        </div>
                    </div>
                `;
                
                // Insérer le message d'erreur en haut du formulaire
                const firstElement = form.querySelector('.grid');
                if (firstElement) {
                    form.insertBefore(errorDiv, firstElement);
                }
                
                // Faire défiler vers le haut
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Animation de chargement
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = `
                        <i class="fas fa-spinner fa-spin"></i>
                        Enregistrement...
                    `;
                    submitButton.disabled = true;
                }
            }
        });
    }
});
</script>

<style>
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.transition-colors {
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

/* Amélioration du focus pour l'accessibilité */
.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>